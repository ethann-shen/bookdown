# Results 


```{r load-results-files}
load("source/data/league_average_speeds.Rda")
load("source/data/total_speeds_modeling.Rda")
load("source/data/league_tables.Rda")
load("source/data/england_defense_total_speed_dfs.Rda")
load("source/data/top_team_averages.Rda")
load("source/data/all_league_grids.Rda")
load("source/data/england_all_speeds.Rda")
load("source/data/abbreviation_df.Rda")
```

## Pace of Play by Polygon 

We first examined how pace differs among the 294 polygons in the EPL. 

```{r}
yup = tibble(
  grid = 1:294,
  england_all_median_E_speed = england_all_median_E_speed,
  england_all_median_EW_speed = england_all_median_EW_speed,
  england_all_median_NS_speed = england_all_median_NS_speed,
  england_all_median_total_speed = england_all_median_total_speed
) %>% 
  tidyr::gather(direction, value, england_all_median_E_speed:england_all_median_total_speed) %>% 
  mutate(direction = str_remove_all(direction, "england_all_median_|_speed"),
         direction = ifelse(direction == "total",  "Total", direction) %>% 
           factor(levels = c("Total", "EW", "NS", "E"))) 

create_facet_heatmap(yup %>% rename(club = direction), nrow = 2, ncol = 2, legend_scale = "sequential") + labs(fill = "Speed (m/s)")
epl1 <- create_heatmap(grids5x5, england_all_median_total_speed) + labs(subtitle = "Total", fill="") + theme_void() +
  theme(plot.subtitle = element_text(hjust = 0.5))
epl2 <- create_heatmap(grids5x5, england_all_median_EW_speed) + labs(subtitle = "EW", fill="") + theme_void() +
  theme(plot.subtitle = element_text(hjust = 0.5))
epl3 <- create_heatmap(grids5x5, england_all_median_NS_speed) + labs(subtitle = "NS", fill="") + theme_void() +
  theme(plot.subtitle = element_text(hjust = 0.5))
epl4 <- create_heatmap(grids5x5, england_all_median_E_speed) + labs(subtitle = "E", fill="") + theme_void() +
  theme(plot.subtitle = element_text(hjust = 0.5))

gridExtra::grid.arrange(epl1,  epl2, epl3, epl4, ncol = 2)
```

Total speed is the fastest in the polygons within the opposing team’s penalty box and along the opposing team’s goal line. This is primarily due to higher NS velocities in those areas, as EW speed is relatively slow. Passes completed within the penalty box will usually be taken faster, as players will often be looking for goal-scoring opportunities but will also be under more pressure from defenders. In addition, corner kicks often have a higher velocity than most passes. Most corners are taken into the 6-yard box, so their trajectories will intersect with the polygons along the goal line. 

It is interesting to note that in the offensive half of the pitch, total speed is slower along the left and right flanks and faster in the middle. This is primarily driven by the patterns in the EW and NS speeds, as EW speed is generally faster along the flanks while NS speed is faster in the middle. However, the NS speeds in the middle are faster than the EW speeds along the flanks, which is why total speed is also faster in the middle. 

From the E-only speeds, it seems like the teams in the EPL prefer to advance the ball past the center line along the flanks, rather than down the middle. At the end of the 2017/18 season, 8 out of the 10 players with the most assists were most often deployed as either left or right wingers or midfielders. Another interesting result is that E-only speed is relatively similar in the offensive and defensive thirds. A prior study suggests that a decline in E-only speed in the offensive third should be expected since there are diminishing returns for advancing the ball forward [[7]][Reference]. However, this decline in speed is only apparent in the polygons around the 6-yard box. In most cases, players who receive the ball in this position would shoot, as these positions provide players with the optimal shooting angles. However, E-only speed does not decline in other polygons in the offensive third. Central midfielders stationed around the outskirts penalty box could pass the ball to wingers on the left or right flanks. Even though the shooting angle worsens for the wingers, they can easily advance toward the goal line and cross the ball to the penalty box or cut back [https://www.washingtonpost.com/news/fancy-stats/wp/2014/10/16/two-of-soccers-most-dangerous-passes/] to an onrushing player, both of which could lead to goal-scoring opportunities. 

## Pace of Play by Zone 

We first examined how pace differs among the 8 zones in the EPL. 

```{r EPL-avg-velocities, fig.align="center", fig.cap="Velocity by Zone in the EPL for the 2017-18 regular season"}
col.pal <- c("#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666")

league_average_speeds %>% 
  select(zone, direction, mean_england_zones) %>% 
  tidyr::gather(league, value, mean_england_zones) %>% 
  mutate(league = str_remove_all(league, "mean_|_zones") %>% str_to_title()) %>% 
  mutate(direction = ifelse(direction == "total",  "Total", direction) %>% 
           factor(levels = c("Total", "EW", "NS", "E"))) %>% 
  ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_grid(.~direction, scales = "free_y") +
  labs(fill = "Zone", y = "Speed (m/s)") + 
  scale_fill_manual(values=col.pal) + 
  theme_bw() +   
  guides(fill = guide_legend(nrow = 1)) + 
  theme(axis.title.x =element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom")


```

We noticed that total speed is the highest in zone 8 and approximately 28-37% slower in the other seven regions. This is primarily due to the disparity among the NS speeds, particularly in zone 8, as EW speed is roughly equal in all zones. Zone 8 contains the highest NS speed because the velocities of corner kicks are all recorded in this zone. In addition, we also expect zones 2, 4, 5 and 7 to have the highest EW speeds and lowest NS speeds - in these zones, players can pass forwards and backwards, but only up or down, depending on their position on the pitch. 

[[7]][References] notes that a decline in E-only speed in the offensive half of the pitch should be expected since there are diminishing returns for advancing the ball forward / A prior study suggests that a decline in E-only speed in the offensive half of the pitch should be expected since there are diminishing returns for advancing the ball forward [[7]][References]. However, our analysis displays a contrasting result, as the E-only speeds in the offensive half of the pitch are similar to those in the defensive half and the highest in zones 7 and 8. Even though advancing the ball forward along the sides of the pitch will result in worse shooting angles, it opens that player to cross the ball to the penalty box or cut back to an onrushing player, both of which could lead to goal-scoring opportunities. 

## Pace of Play Across Leagues 

Next, we analyzed how pace varies between the EPL and the four other first-division European leagues  (Ligue 1, Bundesliga, Serie A and La Liga). The figure above/below shows the percent difference (league - EPL / EPL) between the average velocities from the EPL and those of the four other European leagues. 

```{r other-leagues-avg-velocities, fig.align="center", fig.cap="Velocity by Zone relative to the EPL for the 2017-18 regular season"}
league_average_speeds %>% 
  mutate(`Ligue 1` = map2(mean_england_zones, mean_france_zones, perc_change) %>% unlist(),
         Bundesliga = map2(mean_england_zones, mean_germany_zones, perc_change) %>% unlist(),
         `Serie A` = map2(mean_england_zones, mean_italy_zones, perc_change) %>% unlist(),
         `La Liga` = map2(mean_england_zones, mean_spain_zones, perc_change) %>% unlist()) %>% 
  select(-(mean_england_zones:mean_spain_zones)) %>% 
  tidyr::gather(league, value, `Ligue 1`:`La Liga`) %>% 
  mutate(league = factor(league,  levels = c("Ligue 1", "Bundesliga", "Serie A", "La Liga")),
         direction = ifelse(direction == "total",  "Total", direction) %>% 
           factor(levels = c("Total", "EW", "NS", "E")),
         value = value * 100) %>% 
  ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_grid(direction~league, scales = "free_y") +
  theme_bw()  + 
  geom_hline(yintercept = 0, colour = "black") +
  theme(panel.grid.major = element_blank(), 
        legend.position = "none") + 
  labs(x = "Zone", fill = "Zone", y = expression(paste(Delta, " Speed (%)"))) + 
  scale_fill_manual(values=col.pal)

```

Pace in Ligue 1 is slower in the defensive half of the pitch but mostly faster in the offensive pitch. Total speed is approximately 1% faster in zones 5, 6, 7, and is primarily driven by changes in the EW speed, as NS speed is relatively similar to that of the EPL. This could be due to the fact that the average number of goals scored per game is slightly higher in Ligue 1 than in the EPL (2.72 vs. 2.68). Faster pace in the offensive half can yield more goal-scoring opportunities. In addition, the 2017-2018 season saw the transfer of Neymar from Barcelona to PSG and the emergence of Kylian Mbappe. While Ligue 1 is often described as a poor attacking league, the advent/presence of this formidable attacking duo may have reinvigorated the league [[8]][References]. 

Differences in the offensive half are most notable in the Bundesliga. Total speed in the Bundesliga is 2-4% faster in zones 5, 6, 7 and is driven by an increase in both the EW and NS speeds. The increase in total could have been due to a higher average number of goals scored per game compared to the EPL (2.79 vs. 2.68). Additionally, Bundesliga players are more likely to create scoring chances and take more shots than those in the other four leagues [[9]][References], which is corroborated by the fact that the E-only speeds are approximately 3-5% faster than the EPL.

Pace in Serie A is generally slower and primarily driven by a decline in EW speed across seven zones, with the most noteworthy occurring in zone 1. We performed a simulation based hypothesis test and determined there is no significant difference in the zone 1 speeds of the EPL and Serie A. Nothing in the data or the available literature provides any further insight on this phenomenon. 

La Liga displays the smallest difference in pace, with slightly slower speeds in zones 1 and 2. We expected La Liga teams to have the slowest velocities in the defensive half, as they are known for playing out from the back, a common tactic in which teams begin passing in their defensive third. This type of build-up play can help increase the quality of passes into teams’ midfielders and forwards. Goalkeepers such as Keylor Navas, Jan Oblak, Marc-Andre Ter Stegen, and Kepa all possess excellent ball control and distribution, which thus allows their teams to start plays from the back [“common” knowledge, as per experts & critics, 6]. 

In recent years, more EPL teams have been adopting this tactic. Manchester City, with goalkeeper Ederson, is one of the best teams at playing from out from the back. When Pep Guardiola took over in 2016, he seeked to implement a system that plays out from the back, which requires a goalkeeper who is comfortable with the ball on their feet and is capable of building plays from the back [1,2,3]. Replacing long-term goalkeeper Joe Hart with Ederson, someone who fulfills Guardiola’s needs, has contributed to their recent success. Although this style of play has a myriad of benefits, not all teams are capable of executing this tactic. Playing out from the back requires precise passes, as one wayward pass could fall into the feet of an opposing player. Some goalkeepers, such as Tottenham’s Hugo Lloris, arguably one of the world’s best goalkeepers in terms of anticipation and one-on-one situations, lack the ability to pick out the right passes and prevent their teams from adopting this tactic [1, 5]. The mixed success of playing from the back in the EPL may have contributed to the slight difference in pace in the defensive half in comparison to La Liga. 

sources: 
https://www.espn.com/soccer/english-premier-league/story/3945761/why-playing-out-from-the-back-has-brought-mixed-results-for-premier-league-clubs
https://www.mirror.co.uk/sport/football/news/pep-guardiola-explains-axing-joe-13445300
https://worldfootballindex.com/2019/09/playing-out-from-the-back-tactics-analysis-guardiola-lillo/
https://themastermindsite.com/2019/08/20/playing-out-from-the-back-full-session-plan-and-key-coaching-points/
https://bleacherreport.com/articles/2716942-ranking-the-best-goalkeepers-in-world-football
https://bleacherreport.com/articles/2790722-why-kepa-arrizabalaga-is-the-most-expensive-keeper-in-the-world

In general, players from La Liga and the EPL display the most similar performance-related match actions [[9]][Reference] and recorded a similar average number of goals per game (2.69 vs. 2.68), suggesting that only slight differences in pace should be expected between these two leagues. 

Ultimately, differences between these leagues are likely due to stylistic differences between leagues and individual teams, rather than differences in player ability. (not sure if this sentence is necessary)

## EPL Team-level Pace (Grid)

We examined team-level pace for the 20 teams in the EPL using both the grid and zonal methods and compared each team’s total speeds to the EPL league average.

```{r fig.align = "center", fig.cap="Grid analysis of total speed by team vs. EPL average while attacking. Select teams are ordered by final standings. All units are in m/s.", fig.width=14, fig.height=10}
epl_10 <- epl_grids %>% 
  mutate(median_liverpool_total_speed = ifelse(median_liverpool_total_speed >= 72, NA,  median_liverpool_total_speed)) %>%
  mutate_at(vars(-matches("median_england_total_speed")), list( ~ . - median_england_total_speed)) %>% 
  select(-median_england_total_speed) %>% 
  rename_all( ~ str_remove_all(.x, "median_|_total_speed") %>% str_replace_all("_", " ")) %>% 
  select(`man city`,  `Manchester United`, `Tottenham Hotspur`, liverpool, `crystal palace`, `bournemouth`, `Stoke City`, wba) %>% 
  mutate(bournemouth = ifelse(bournemouth >= 2,  0, bournemouth)) %>% 
  mutate(zone = 1:294) %>% 
  gather(club, value,  `man city`:wba) %>% 
  mutate(club = str_to_title(club),
         club = case_when(
           club == "Man City" ~ "Manchester City", 
           club == "Bournemouth" ~ "AFC Bournemouth", 
           club == "Wba"~ "West Bromwich Albion",
           TRUE ~ as.character(club)
         )) %>% 
  left_join(league_tables %>% 
              slice(1:20) %>% 
              select(Pos, Team),
            by = c("club" = "Team")) %>% 
  mutate(club = paste0(club, " (", Pos, ")"), 
         club = reorder(club, Pos)) #%>% 
# left_join(abbreviation_df, by = "club") %>% 
# mutate(club = paste0(abb, " (", Pos, ")"),
#        club = reorder(club, Pos))

create_facet_heatmap(epl_10 %>% 
                       mutate(value = ifelse(value >= quantile(value, na.rm=TRUE, 0.995),
                                             quantile(value, na.rm=TRUE, 0.995), value)) %>% 
                       mutate(value = ifelse(value <= quantile(value, na.rm=TRUE, 0.0025),
                                             quantile(value, na.rm=TRUE, 0.0025), value)), legend_scale = "diverging") +
  labs( fill = expression(paste(Delta, " Speed (m/s)"))) #+ guides(fill = guide_legend(label.position = "left", label.hjust = 1))
```

Figure XXXX displays the difference between the median total velocity in each 5x5m grid for 8 teams and that of the EPL average, with the rest displayed in the Appendix. None of these teams are faster or slower in all 294 grids, but the pace of the top six teams (Manchester City, Manchester United, Tottenham Hotspur, Liverpool, Chelsea and Arsenaal) is generally slower than the league average. As we move down the league table, the grid velocities display more variation, but the four bottom-tier teams in Figure XXXX are generally faster. It might seem odd that the top tier teams have a slower pace, but this is primarily due to the way we define pace. We expect these teams to maintain possession for a greater portion of the game and complete more passes. It is more likely for teams to maintain possession when making shorter, more controlled passes. Thus, we expect that the average distance and velocity per pass to increase as we move down the league table. 

In addition, goal kicks from the top four teams are relatively slower than the league average, with Manchester City's having the slowest velocities. Although there is some variation, goal kicks from the bottom tier teams are generally faster than the league average. Since lower tier teams may not have possession for long periods of time, their goalkeepers may feel pressured to take longer goal kicks down the pitch, with the hope that one could create a goal-scoring opportunity. This is corroborated by the fact that Manchester City’s goalkeeper Ederson took 71% of his Premier League passes short, while every other goalkeeper, except for Liverpool's Simon Mignolet, took less than 50% of their passes short [[11]][References].

```{r}
epl_10_defense <- all_grid_england_defense_speed %>% 
  mutate(club = case_when(
    club == "Afc Bournemouth" ~ "AFC Bournemouth",
    club == "Brighton Hove Albion" ~ "Brighton & Hove Albion",
    TRUE ~ as.character(club)
  )) %>% 
  gather(zone, value, -club) %>% 
  spread(club, value) %>% 
  mutate(zone = str_remove_all(zone, "zone") %>% as.numeric()) %>% 
  arrange(zone) %>% 
  bind_cols(epl_grids %>% select(median_england_total_speed)) %>% 
  mutate_at(vars(-matches("median_england_total_speed"), -matches("zone")), list( ~ . - median_england_total_speed)) %>% 
  select(-median_england_total_speed) %>% 
  gather(club, value,  `AFC Bournemouth`:`West Ham United`, -zone) %>% 
  left_join(league_tables %>% 
              slice(1:20) %>% 
              select(Pos, Team),
            by = c("club" = "Team")) %>% 
  filter(club %in% c("Manchester City", "Manchester United", "Tottenham Hotspur", "Liverpool", "Crystal Palace", "AFC Bournemouth", "Stoke City", "West Bromwich Albion")) %>% 
  mutate(club = paste0(club, " (", Pos, ")"),
         club = reorder(club, Pos)) 

create_facet_heatmap(epl_10_defense %>% 
                       mutate(value = ifelse(value >= quantile(value, na.rm=TRUE, 0.995), 
                                             quantile(value, na.rm=TRUE, 0.995), 
                                             ifelse(value <= quantile(value, na.rm=TRUE, 0.0025),
                                                    quantile(value, na.rm=TRUE, 0.0025), value))),
                     legend_scale = "diverging") +
  labs( fill = expression(paste(Delta, " Speed (m/s)")))

# %>% mutate(value = ifelse(value >= quantile(value, na.rm=TRUE, 0.995), quantile(value, na.rm=TRUE, 0.995), ifelse(value <= quantile(value, na.rm=TRUE, 0.005),quantile(value, na.rm=TRUE, 0.005), value)))
```

While defending, these 8 teams also display variability between different grids and regions on the pitch. The top 4 teams generally gave up more pace in the offensive zones, with the exception of Manchester United. One reason for this discrepancy could be due to Jose Mourinho’s leadership. Under Mourinho, Manchester United line up in a 4-3-3 formation that shifts to a 4-1-4-1 defensively. He is known for playing cautiously in big games; rather than imposing his style, he often looks to counter the opponents. For example, he has played 4-5-1 and 6-3-1 formations into draws against Liverpool, two defensive line ups that heavily negate Liverpool’s dynamic front three. In addition, Manchester United’s goal-keeper, David de Gea, was the best goalkeeper in the league with 18 clean sheets. 

sources: 
https://www.youtube.com/watch?v=1JBDCilBnas
https://www.skysports.com/football/news/11667/11278517/jose-mourinho-under-pressure-to-attack-when-manchester-united-host-liverpool
https://spielverlagerung.com/2016/10/19/mourinhos-midfield-pressing-and-6-3-1-halts-klopps-side/
https://www.coachbetter.com/new-posts/soccer-tactic-why-is-the-4-1-4-1-the-best-formation/


## EPL Team-level Pace (Zonal)

We also examined team-level pace using the zonal method, which allows us to get a more high-level understanding of how pace varies across different clubs in the EPL. 

```{r epl-team-attacking-zonal, fig.align = "center", fig.cap="Zonal analysis of total speed by team vs. EPL average while attacking. Teams are ordered by final standings from the 2017-18 season. All units are in m/s.", fig.width=17, fig.height=12}
all_total_avg_speeds %>% slice(1:20) %>% 
  rownames_to_column() %>% 
  gather(zone, value, -club) %>% 
  spread(club, value) %>% 
  filter(zone != "rowname") %>% 
  bind_cols(
    league_average_speeds %>% filter(direction == "total") %>% select(mean_england_zones)
  ) %>%
  select(-zone) %>% 
  mutate_if(is.character, as.double) %>% 
  mutate_at(vars(-matches("mean_england_zones"), -matches("zone")), list( ~ . - mean_england_zones)) %>% 
  select(-mean_england_zones) %>% 
  mutate(zone = 1:8) %>% 
  gather(club, value,  `AFC Bournemouth`:`West Ham United`, -zone) %>% 
  left_join(league_tables %>% slice(1:20) %>% select(Pos, Team),
            by = c("club" = "Team")) %>% 
  mutate(club = paste0(club, " (", Pos, ")"),
         club = reorder(club, Pos)) %>%
  # left_join(abbreviation_df, by = "club") %>% 
  # mutate(abb = case_when(
  #   club == "AFC Bournemouth" ~ "BOU",
  #   club == "Brighton & Hove Albion" ~ "BHA",
  #   club == "Huddersfield Town" ~ "HUD",
  #   club == "Stoke City" ~ "STO",
  #   club == "Swansea City" ~ "SWA",
  #   club == "Watford" ~ "WAT",
  #   TRUE ~ as.character(abb)
  # )) %>% 
  # mutate(club = paste0(abb, " (", Pos, ")"),
#        club = reorder(club, Pos))  %>% 
ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_wrap(.~club,nrow = 2, labeller = label_wrap_gen(width=14.5)) +
  theme_bw()  + 
  geom_hline(yintercept = 0, colour = "black") +
  labs( fill = "Zone", y = expression(paste(Delta, " Speed (m/s)"))) + 
  theme(panel.grid.major = element_blank(),
        axis.title.x =element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y = element_text(size = 18),
        axis.text.y.left = element_text(size = 16),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        strip.text.x = element_text(size = 14.5), # text for facet_wrap labels
        legend.position = "bottom") + 
  guides(fill = guide_legend(nrow = 1)) + 
  scale_fill_manual(values=col.pal) 
```

The overall results verify those found in the grid analysis. The top six teams (Manchester City, Manchester United, Tottenham Hotspur, Liverpool, Chelsea and Arsenal) were consistently slower than the league averages in all but 3 instances. As we move down the table, the zonal speeds display more variation, but these teams are generally faster than the league average. While attacking, teams such as Liverpool (4) and AFC Bournemouth (12) are faster than the league average in some zones and slower in other zones. However, the majority of the teams are either faster or slower in all 8 zones. For example, Newcastle United’s (10) speeds are faster in all 8 zones, while those of Manchester City (1) are all slower. 

```{r epl-team-defending-zonal, fig.align = "center", fig.cap="Zonal analysis of total speed by team vs. EPL average while defending. Teams are ordered by final standings from the 2017-18 season. All units are in m/s.", fig.width=17, fig.height=10}
theme_update(text = element_text(size=16))
all_england_defense_speed %>% 
  mutate(club = case_when(
    club == "Afc Bournemouth" ~ "AFC Bournemouth",
    club == "Brighton Hove Albion" ~ "Brighton & Hove Albion",
    TRUE ~ as.character(club)
  )) %>% 
  gather(zone, value, -club) %>% 
  spread(club, value) %>% 
  bind_cols(
    league_average_speeds %>% filter(direction == "total") %>%  select(mean_england_zones)
  ) %>% 
  mutate_at(vars(-matches("mean_england_zones"), -matches("zone")), list( ~ . - mean_england_zones)) %>% 
  select(-mean_england_zones) %>% 
  mutate(zone = 1:8) %>% 
  gather(club, value,  `AFC Bournemouth`:`West Ham United`, -zone) %>% 
  left_join(league_tables %>% slice(1:20) %>% select(Pos, Team),
            by = c("club" = "Team")) %>% 
  # mutate(club = paste0(club, " (", Pos, ")"),
  #        club = reorder(club, Pos)) %>% 
  left_join(abbreviation_df, by = "club") %>% 
  mutate(abb = case_when(
    club == "AFC Bournemouth" ~ "BOU",
    club == "Brighton & Hove Albion" ~ "BHA",
    club == "Huddersfield Town" ~ "HUD",
    club == "Stoke City" ~ "STO",
    club == "Swansea City" ~ "SWA",
    club == "Watford" ~ "WAT",
    TRUE ~ as.character(abb)
  )) %>%
  mutate(club = paste0(abb, " (", Pos, ")"),
         club = reorder(club, Pos)) %>% 
  ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_wrap(.~club,nrow = 2, ) +
  theme_bw()  + 
  geom_hline(yintercept = 0, colour = "black") +
  labs(fill = "Zone", y = expression(paste(Delta, " Speed (m/s)"))) + 
  theme(panel.grid.major = element_blank(),
        axis.title.x =element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y = element_text(size = 16),
        axis.text.y.left = element_text(size = 16),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 14),
        strip.text.x = element_text(size = 16), # text for facet_wrap labels
        legend.position = "bottom") + 
  guides(fill = guide_legend(nrow = 1)) + 
  scale_fill_manual(values=col.pal)
```

While defending, only Manchester City consistently gave up more pace, while the other 19 teams displayed variability between different zones. The top 6 teams generally gave up more pace in the offensive zones, with the exception of Manchester United (2). 






```{r}
# IGNORE EVERYTHING UNDER HERE
knitr::opts_chunk$set(eval = FALSE, 
                      message=FALSE, 
                      warning=FALSE)
```


```{r}
knitr::opts_knit$set(root.dir = "/Users/ethanshen/Documents/College/Fa20/pace-of-play")
```

```{r}
library(tidyverse)
library(sf)
load("grids5x5.Rda")
load("zones.Rda")
load("data/filtered_england_speeds.Rda")
load("data/filtered_france_speeds.Rda")
load("data/filtered_germany_speeds.Rda")
load("data/filtered_italy_speeds.Rda")
load("data/filtered_spain_speeds.Rda")
source("source.R")
load("league_average_speeds.Rda")
```

maybe should focus more granular things on just the EPL, 

# Exploring Pace 

## Pace-of-Play Across the Pitch


```{r}
library(patchwork)
load("england/man_city/man_city_total_speeds.Rda")
load("england/liverpool/liverpool_total_speeds.Rda")
load("england/bournemouth/bournemouth_total_speeds.Rda")
load("england/wba/wba_total_speeds.Rda")
p1 <- create_heatmap(grids5x5, median_man_city_total_speed) + theme_void() + labs(y = "Manchester City") 
p2 <- create_heatmap(grids5x5, ifelse(median_liverpool_total_speed > 45, NA, median_liverpool_total_speed)) + theme_void()
p3 <- create_heatmap(grids5x5, median_bournemouth_total_speed) + theme_void()
p4 <- create_heatmap(grids5x5, median_wba_total_speed) + theme_void()
#(p1 | p2) / (p3 | p4)

library(ggpubr)
ggarrange(p1, p2, p3, p4, ncol=2, nrow=2, common.legend = TRUE, legend="bottom")

```


## Pace-of-Play by Zone 

- pace by zone  for all leagues
- pace by zone for 5 EPL teams, and top team from other leagues


## Pace-of-Play by League

```{r include=FALSE}
folders <- c("spain", "germany", "italy", "england", "france")
files <- list.files(path = paste0("", folders, "/all"))
files <- files[!str_detect(files, "intersection")]
leagues <- files %>% str_split("_") %>% map(1) %>% unlist()
lapply(paste0("", leagues, "/all/", files), load , .GlobalEnv) %>% invisible()

england_all_median_E_speed <- england_all_E_speed %>% map_dbl(median, na.rm=TRUE)
england_all_median_EW_speed <- england_all_EW_speed %>% map_dbl(median, na.rm=TRUE)
england_all_median_NS_speed <- england_all_NS_speed %>% map_dbl(median, na.rm=TRUE)
england_all_median_total_speed <- england_all_total_speed %>% map_dbl(median, na.rm=TRUE)
england_pass_count <- map(england_all_total_speed, ~.[!is.na(.)]) %>% map_dbl(length)

france_all_median_E_speed <- france_all_E_speed %>% map_dbl(median, na.rm=TRUE)
france_all_median_EW_speed <- france_all_EW_speed %>% map_dbl(median, na.rm=TRUE)
france_all_median_NS_speed <- france_all_NS_speed %>% map_dbl(median, na.rm=TRUE)
france_all_median_total_speed <-  france_all_total_speed %>% map_dbl(median, na.rm=TRUE)
france_pass_count <- map(france_all_total_speed, ~.[!is.na(.)]) %>% map_dbl(length)

germany_all_median_E_speed <- germany_all_E_speed %>% map_dbl(median, na.rm=TRUE)
germany_all_median_EW_speed <-  germany_all_EW_speed   %>% map_dbl(median, na.rm=TRUE)
germany_all_median_NS_speed <-germany_all_NS_speed %>% map_dbl(median, na.rm=TRUE)
germany_all_median_total_speed <-germany_all_total_speed %>% map_dbl(median, na.rm=TRUE)
germany_pass_count <- map(germany_all_total_speed, ~.[!is.na(.)]) %>% map_dbl(length)

italy_all_median_E_speed <- italy_all_E_speed %>% map_dbl(median, na.rm=TRUE)
italy_all_median_EW_speed <-italy_all_EW_speed %>% map_dbl(median, na.rm=TRUE)
italy_all_median_NS_speed <- italy_all_NS_speed %>% map_dbl(median, na.rm=TRUE)
italy_all_median_total_speed <- italy_all_total_speed %>% map_dbl(median, na.rm=TRUE)
italy_pass_count <- map(italy_all_total_speed, ~.[!is.na(.)]) %>% map_dbl(length)

spain_all_median_E_speed <- spain_all_E_speed %>% map_dbl(median, na.rm=TRUE)
spain_all_median_EW_speed <-spain_all_EW_speed %>% map_dbl(median, na.rm=TRUE)
spain_all_median_NS_speed <-  spain_all_NS_speed %>% map_dbl(median, na.rm=TRUE)
spain_all_median_total_speed <- spain_all_total_speed %>% map_dbl(median, na.rm=TRUE)
spain_pass_count <- map(spain_all_total_speed, ~.[!is.na(.)]) %>% map_dbl(length)

team_median_speed_files <- ls(envir=.GlobalEnv)[str_detect(ls(envir=.GlobalEnv), "all_median")]
england_files <- team_median_speed_files[str_detect(team_median_speed_files, "england")]
france_files <- team_median_speed_files[str_detect(team_median_speed_files, "france")]
germany_files <- team_median_speed_files[str_detect(team_median_speed_files, "germany")]
italy_files <- team_median_speed_files[str_detect(team_median_speed_files, "italy")]
spain_files <- team_median_speed_files[str_detect(team_median_speed_files, "spain")]


league_average_speeds <- tibble(
  zone = 1:8 %>% rep(4),
  direction = str_split(england_files, "_") %>% map(4) %>% unlist() %>% rep(each=8),
  mean_england_zones = map(england_files, ~fill_zones(zones = zones, speeds = eval(parse(text=.)), metric=mean)) %>% unlist(),
  mean_france_zones = map(france_files, ~fill_zones(zones = zones, speeds = eval(parse(text=.)), metric=mean)) %>% unlist(),
  mean_germany_zones = map(germany_files, ~fill_zones(zones = zones, speeds = eval(parse(text=.)), metric=mean)) %>% unlist(),
  mean_italy_zones = map(italy_files, ~fill_zones(zones = zones, speeds = eval(parse(text=.)), metric=mean)) %>% unlist(),
  mean_spain_zones = map(spain_files, ~fill_zones(zones = zones, speeds = eval(parse(text=.)), metric=mean)) %>% unlist(),
) 

save(league_average_speeds, file = "league_average_speeds.Rda")
```

```{r}
league_average_speeds %>% 
  select(zone, direction, mean_england_zones) %>% 
  tidyr::gather(league, value, mean_england_zones) %>% 
  mutate(league = str_remove_all(league, "mean_|_zones") %>% str_to_title()) %>% 
  mutate(direction = ifelse(direction == "total",  "Total", direction) %>% 
           factor(levels = c("Total", "EW", "NS", "E"))) %>% 
  ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_grid(.~direction, scales = "free_y") +
  labs(x = "Zone", y = "Speed (m/s)", title = "EPL Average Speeds") + 
  theme_bw()  + 
  theme(legend.position = "none")
```

```{r}
league_average_speeds %>% 
  mutate(`Ligue 1` = map2(mean_england_zones, mean_france_zones, perc_change) %>% unlist(),
         Bundesliga = map2(mean_england_zones, mean_germany_zones, perc_change) %>% unlist(),
         `Serie A` = map2(mean_england_zones, mean_italy_zones, perc_change) %>% unlist(),
         `La Liga` = map2(mean_england_zones, mean_spain_zones, perc_change) %>% unlist()) %>% 
  select(-(mean_england_zones:mean_spain_zones)) %>% 
  tidyr::gather(league, value, `Ligue 1`:`La Liga`) %>% 
  mutate(league = factor(league,  levels = c("Ligue 1", "Bundesliga", "Serie A", "La Liga")),
         direction = ifelse(direction == "total",  "Total", direction) %>% 
           factor(levels = c("Total", "EW", "NS", "E")),
         value = value * 100) %>% 
  ggplot() + 
  geom_bar(aes(x = as.factor(zone), weight = value, fill = as.factor(zone))) + 
  facet_grid(direction~league, scales = "free_y") +
  theme_bw()  + 
  geom_hline(yintercept = 0, colour = "black") +
  theme(#panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(), 
  ) + 
  labs(title = "League speed relative to the EPL for the 2017-18 regular season", x = "Zone", fill = "Zone", y = expression(paste(Delta, " Speed (%)")))
```

# Hypothesis Test of Zone 1 EPL vs Serie A

```{r}
load("bootstrap example/england_EW_zone_1_bootstrap.Rda")
load("bootstrap example/italy_EW_zone_1_bootstrap.Rda")
```

```{r}
tibble(
  stat = england_EW_zone_1_bootstrap - italy_EW_zone_1_bootstrap
) %>% 
  mutate(lower = quantile(stat, 0.025, na.rm=TRUE), 
         upper = quantile(stat, 0.975, na.rm=TRUE)) %>% 
  ggplot() + 
  geom_histogram(aes(x = stat), fill = "#A8CEE4", color = "#0C1E75", binwidth = 0.0125) + 
  geom_vline(aes(
    xintercept = league_average_speeds %>% filter(zone == 1, direction == "EW") %>% pull(mean_england_zones) -
      league_average_speeds %>% filter(zone == 1, direction == "EW") %>% pull(mean_italy_zones) 
  )) + 
  geom_vline(aes(xintercept = lower)) + 
  geom_vline(aes(xintercept = upper)) + 
  labs(title  =  "Bootstrap of Zone 1 (EPL - Serie A)")

```




- look at league pace averages across the zones
- look at diff in pace between top team minus league averages across zones

event speed / ball speed something diff

dump things onto the doc, cut things as we go 

# last section
sensitivity analysis - increasing or decreasing # of events/possession
- maybe look at one section/proboably  zonal analysis 

comparing top teams to bottom teams in terms of # of passes/possessions
- really clarify that top teams have more passes included in this analysis 

```{r}
passes_per_poss <- filtered_england_speeds %>% 
  tbl_df() %>% 
  #filter(name %in% c("Manchester City", "Liverpool", "Crystal Palace", "AFC Bournemouth", "West Bromwich Albion")) %>%
  group_by(name, match_id, match_period, poss_id) %>% 
  summarise(pass_count = n())

passes_per_poss %>% 
  group_by(name) %>% 
  summarise(avg_passes_per_poss = mean(pass_count),
            sd_passes_per_poss = sd(pass_count),
            median_passes_per_poss = median(pass_count))

passes_per_poss %>%
  # mutate(name = factor(name, levels = c("Manchester City", "Liverpool", "Crystal Palace", "AFC Bournemouth", "West Bromwich Albion"))) %>% 
  ggplot() + geom_boxplot(aes(x = name, y = pass_count)) + 
  #ylim(0,40) + 
  labs(title = "Avg # of Passes / possession")
# man city huge outlier is man city vs afc bournemouth, won 4-0
```


```{r}
england_match_poss_count <- filtered_england_speeds %>% 
  tbl_df() %>% 
  group_by(match_id) %>% 
  summarise(poss_count = n_distinct(poss_id)) 

france_match_poss_count <- filtered_france_speeds %>% 
  tbl_df() %>% 
  group_by(match_id) %>% 
  summarise(poss_count = n_distinct(poss_id)) 

germany_match_poss_count <- filtered_germany_speeds %>% 
  tbl_df() %>% 
  group_by(match_id) %>% 
  summarise(poss_count = n_distinct(poss_id)) 

italy_match_poss_count <- filtered_italy_speeds %>% 
  tbl_df() %>% 
  group_by(match_id) %>% 
  summarise(poss_count = n_distinct(poss_id)) 

spain_match_poss_count <- filtered_spain_speeds %>% 
  tbl_df() %>% 
  group_by(match_id) %>% 
  summarise(poss_count = n_distinct(poss_id)) 

bind_rows(
  england_match_poss_count %>% mutate(league = "EPL"),
  france_match_poss_count %>% mutate(league = "Ligue 1"),
  germany_match_poss_count %>% mutate(league = "Bundesliga"),
  italy_match_poss_count %>% mutate(league = "Serie A"),
  spain_match_poss_count %>% mutate(league = "La Liga")
) %>% 
  mutate(league = factor(league, levels = c("EPL", "Ligue 1", "Bundesliga",  "Serie A", "La Liga"))) %>% 
  ggplot() + 
  geom_boxplot(aes(x = poss_count)) + 
  facet_grid(league~.) + 
  labs(title = "Average # of Possessions in a Game", subtitle = "after filtering >=3 passes/possession")
```


```{r}
# col pals 
col.pal1 <- c("#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666")
col.pal2 <- c("#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666") # this is good!
col.pal3 <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00")
col.pal4 <- c("#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc")
col.pal5 <- c("#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf")
col.pal6 <- c("#66c2a5", "#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3")
col.pal7 <- c("#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5")

p  + scale_fill_manual(values=col.pal1)
p  + scale_fill_manual(values=col.pal2)
p  + scale_fill_manual(values=col.pal3)
#p  + scale_fill_manual(values=col.pal4)
p  + scale_fill_manual(values=col.pal5)
p  + scale_fill_manual(values=col.pal6)
p + scale_fill_manual(values=col.pal7)
```


```{r}
library(rvest)
abb = read_html("https://www.sporcle.com/games/easterbunny/football-club--by-abbreviations-/results") %>% html_nodes(".name")  %>% html_text()


read_html("https://www.sporcle.com/games/easterbunny/football-club--by-abbreviations-/results") %>% html_nodes(".name+ td")  %>% html_text() %>%str_trim()

abb_df <- tibble(
  abb = read_html("https://www.sporcle.com/games/easterbunny/football-club--by-abbreviations-/results") %>% html_nodes(".name")  %>% html_text(),
  name= read_html("https://www.sporcle.com/games/easterbunny/football-club--by-abbreviations-/results") %>% html_nodes(".name+ td")  %>% html_text() %>%str_trim()
  
)
```


```{r}
all_total_avg_speeds %>% slice(1:20) %>% 
  rownames_to_column() %>% 
  gather(zone, value, -club) %>% 
  spread(club, value) %>% 
  filter(zone != "rowname") %>% 
  bind_cols(
    league_average_speeds %>% filter(direction == "total") %>% select(mean_england_zones)
  ) %>%
  select(-zone) %>% 
  mutate_if(is.character, as.double) %>% 
  mutate_at(vars(-matches("mean_england_zones"), -matches("zone")), list( ~ . - mean_england_zones)) %>% 
  select(-mean_england_zones) %>% 
  mutate(zone = 1:8) %>% 
  gather(club, value,  `AFC Bournemouth`:`West Ham United`, -zone)  %>% 
  select(club) %>% distinct() %>% 
  left_join(
    abbreviation_df, by = "club"
  ) %>% 
  mutate(abb = case_when(
    club == "AFC Bournemouth" ~ "BOU",
    club == "Brighton & Hove Albion" ~ "BHA",
    club == "Huddersfield Town" ~ "HUD",
    club == "Stoke City" ~ "STO",
    club == "Swansea City" ~ "SWA",
    club == "Watford" ~ "WAT",
    TRUE ~ as.character(abb)
  ))
```

```{r}
abbreviation_df <- tibble(
  club = read_html("https://fcmasks.co.uk/football-team-3-letter-short-codes-abbreviations-2021/") %>% 
    html_nodes("tr+ tr td:nth-child(1)") %>% html_text() 
  ,
  abb = read_html("https://fcmasks.co.uk/football-team-3-letter-short-codes-abbreviations-2021/") %>% html_nodes("tr+ tr td:nth-child(2)") %>% html_text()%>% str_remove_all("#")
)
save(abbreviation_df, file = "source/data/abbreviation_df.Rda")
```

