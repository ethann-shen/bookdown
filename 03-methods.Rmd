# Methods

```{r table-of-events, eval=FALSE}
events <- readRDS("data/events/england.Rds") %>% sample_n(20000)

all_events <- events %>% 
  tbl_df() %>% 
  ungroup() %>% 
  select(event_name, sub_event_name) %>% 
  group_by(event_name, sub_event_name) %>% 
  distinct() %>% 
  arrange(event_name, sub_event_name) 

all_events %>% 
  filter(event_name < "Goalkeeper") %>% 
  kable(col.names = c("Event Name", "Sub-Event Name")) %>% 
  collapse_rows(columns = 1, valign = "top") %>%
  kable_styling(full_width = FALSE, position = "float_left", fixed_thead = T)
all_events %>% 
  filter(event_name >="Goalkeeper") %>% 
  kable(col.names = c("Event Name", "Sub-Event Name")) %>% 
  collapse_rows(columns = 1, valign = "top") %>%
  kable_styling(full_width = FALSE, position = "left", fixed_thead = T) 
```

```{r making-grids-zones-plot}
p1 <- grids5x5 %>% 
  mutate(rowid = 1:294) %>% 
  ggplot() + 
  fc_annotate_pitch(fill = NA,color = "#F8FAF7") +
  theme_void() + theme(plot.background = element_rect(fill = "#629A52", 
        color = NA), aspect.ratio = 70/105) + 
  geom_sf(fill = NA) + 
  geom_sf_text(aes(label = rowid)) 
  
p2 <- zones %>%  
  mutate(rowid = 1:8) %>% 
  ggplot() +
  fc_annotate_pitch(fill = "NA",color = "#F8FAF7") +
  theme_void() + theme(plot.background = element_rect(fill = "#629A52", 
        color = NA), aspect.ratio = 70/105, legend.position = "none")  + 
  geom_sf(fill = NA) + 
  #geom_sf(aes(fill = as.factor(rowid)), color = NA, alpha = 0.8) + 
  geom_sf_label(aes(label = rowid)) 
  # geom_sf_label(aes(label = rowid),
  #               nudge_x = c(-0.6,-2.75,-2,-2.75,2.75,2,2.75,0.6),
  #               nudge_y = c(2.5,0,2.5,0,0,2.5,0,2.5)) + 
  #geom_sf(data = grids5x5, aes(geometry = geometry), fill=NA, color = "#2E2E2E50") + 
  #fc_annotate_arrow(x = 52.5, y = -10, palette = "bw") + 
  
#gridExtra::grid.arrange(p1,p2, nrow=1)
```

## Possession ID

Ball possession is the amount of time that a team possesses the ball during a match, but there is no standardized benchmark/definition of what event or events concludes a possession and triggers a new one [[6]][References]. Thus, we created a possession identifier that indicates the current unique possession in a match. In our definition, new possessions begin after a team demonstrates that it has established control of the ball. This occurs in the following situations: at the start of a half, when the team intercepts or successfully tackles the ball, and after the opposing team last touches the ball before it goes out, commits a foul followed by a freekick, or after a shot is taken. A new possession can also begin even if the same team has possession of the ball. For example, if the ball goes out for a throw in for the attacking team, this indicates a new possession for the same attacking team. In addition, if the attacking team makes a pass after a sequence of duels, events in which opposing players contest the ball, this constitutes the same possession. According to our definition above, there were an average of 306 possessions per game. 

## Metrics of Pace 

After creating a possession identifier, we calculated the total ($\Phi_{T}$ or $V_{T}$), east-west ($\Phi_{EW}$ or $V_{EW}$), north-south ($\Phi_{NS}$ or $V_{NS}$), and east-only ($\Phi_{E}$ or $V_{E}$) velocities of each event. The east-west distances ($s_{EW}$ from https://physics.info/symbols/) are determined by the difference of the starting and ending x-coordinates while the north-south distances ($s_{NS}$) are determined by the difference of the starting and ending y-coordinates. The total distances ($s_{T}$) are calculated with the formula $\sqrt{(s_{EW}^2 + s_{NS}^2)}$. Events are assigned an E-only distance ($s_{E}$) only if the pass travels toward the opposing goal. Although the ball rarely travels in a straight line, the dataset does not provide information about its trajectory, so we assume that the ball travels in a straight line from its starting to ending coordinates. (mention DRIBBLING?????)

Next, we determined the duration between events. For each event, the dataset only provides a timestamp in seconds since the beginning of the current half of the match. Thus, within each possession, the duration for an event was calculated as the difference of the timestamp of the following event and that of the current event.  With this definition of duration, the last event in the possession sequence is not included in the calculation of pace. Finally, the speeds of each event are calculated by dividing the corresponding distance by its duration. 

We used the distance travelled and duration between successive passes and free kicks (except for free kick shots and penalty kicks) during the same possession to calculate four different measures of pace, which include total speed and the east-west, north-south, and east-only velocities. E-only velocity differs from EW velocity in that only forward progress is measured, and any backward progress is excluded from the analysis. These metrics are the average velocities of the event rather than the instantaneous velocities, since we did not have access to tracking data. 

When analyzing pace, we only included passes and free kicks (except for free kick shots and penalty kicks) since these events are reliable indicators of the pace of the game. In addition, we only kept possessions that consist of three or more pass or free kick events, as these types of possessions are more definitive of a team’s pace. (MOVE THIS EARLIER???) For the following results and discussion of pace, events will only refer to these passes and free kicks. Following the exclusion of certain possessions, the remaining possessions contained an average of 5.5 events per possession. 

All of the previously mentioned procedures can be implemented with functions in the [**scoutr**](https://github.com/shawnsanto/scoutr) package. 

## Spatial Grids Analysis 

```{r grids-plot, fig.align="center", fig.cap="Plot of the 294 grids on the pitch"}
p1
```


We divided the pitch into 294 equal, non-overlapping 5x5 meter square grids. This is why we decided to rescale the pitch to 105 by 70 meters instead of 105 by 68 meters. The total, EW, NS, and E-only velocity values for a given event was assigned to all polygons in which the event’s path intersects with the polygons. Each polygon contains $n$ velocity values for the $n$ event paths that intersected with it. For each of the 5x5 grids, we then take the median for each of the four different pace metrics. There are grids, particularly ones in the corners or along the attacking team's goal line, that have very few velocity values recorded. Thus, the median was used over the mean to account for the presence of potential outliers.

## Zonal Analysis 

```{r zones-plot, fig.align="center", fig.cap="Plot of the 8 zones on the pitch"}
p2
```

We divided the pitch into 8 regions. For each zone, we determined which of the 294 5x5 grids intersect the zone. As seen in Figure XXXX (should these plots be overlapped or separate plots  like here), there are some polygons that fall into multiple zones, such as grids 1, 23, etc. We then take the mean, median, and standard deviation of the median velocities of those 5x5 grids to determine the aggregate speeds for the zone. 

This method was conducted in favor of another one that assigns an event’s speeds to all zones that intersect the path of the event. Our approach automatically factors in the event’s distance within the zone and is more resistant to outliers. For example, for a pass that intersects $n$ different 5x5 grids in a zone, the zone’s aggregate speed will be affected by that pass’ speed $n$ times instead of just once. This approach is thus more resistant to outliers. 

```{r}
zones %>%  
  mutate(rowid = 1:8) %>% 
  ggplot() +
  fc_annotate_pitch(fill = "NA",color = "#F8FAF7") +
  theme_void() + theme(plot.background = element_rect(fill = "#629A52", 
        color = NA), aspect.ratio = 70/105, legend.position = "none")  + 
  
  geom_sf(aes(fill = as.factor(rowid)), color = NA, alpha = 0.8) + 
  #geom_sf_label(aes(label = rowid)) 
  geom_sf_label(aes(label = rowid),
                nudge_x = c(-0.6,-2.75,-2,-2.75,2.75,2,2.75,0.6),
                nudge_y = c(2.5,0,2.5,0,0,2.5,0,2.5)) +
  geom_sf(data = grids5x5, aes(geometry = geometry), fill=NA, color = "#2E2E2E50")
```



## Modeling

stuff 




